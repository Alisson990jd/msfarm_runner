name: Microsoft Rewards Bot

on:
  workflow_dispatch:
    inputs:
      password:
        description: 'Senha'
        required: true
        type: string

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: üîê Validar senha
        run: |
          if [ "${{ github.event.inputs.password }}" != "${{ secrets.PASS }}" ]; then
            echo "‚ùå Senha incorreta!"
            exit 1
          fi

      - name: üì¶ Checkout
        uses: actions/checkout@v4

      - name: üêç Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üñ•Ô∏è Instalar depend√™ncias do sistema
        run: |
          sudo apt-get update
          sudo apt install -y xfce4
          sudo apt-get install -y xkb-data x11-xkb-utils
          sudo apt-get install -y \
            xvfb \
            x11-utils \
            xauth \
            dbus-x11 \
            libx11-xcb1 \
            libxcomposite1 \
            libxcursor1 \
            libxdamage1 \
            libxi6 \
            libxtst6 \
            libxrandr2 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libgbm1 \
            libgtk-3-0 \
            libnspr4 \
            libnss3 \
            libpango-1.0-0 \
            libpangocairo-1.0-0 \
            libxshmfence1 \
            libglu1-mesa \
            libxkbcommon0 \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-xfixes0 \
            libxcb-xinerama0 \
            fonts-liberation \
            fonts-noto-color-emoji \
            fonts-freefont-ttf

      - name: üì¶ Instalar depend√™ncias Python
        run: |
          pip install --upgrade pip
          pip install discord.py aiohttp
          pip install playwright playwright-stealth
          pip install google-api-python-client google-auth google-auth-oauthlib google-auth-httplib2

      - name: üé≠ Instalar Playwright
        run: |
          playwright install chromium
          playwright install-deps chromium

      - name: üìã Verificar estrutura
        run: |
          echo "üìÅ Arquivos:"
          ls -la
          echo ""
          echo "üìÅ msfarm/:"
          ls -la msfarm/ 2>/dev/null || echo "N/A"
          echo ""
          echo "üìÅ pkl/:"
          ls -la msfarm/pkl/ 2>/dev/null || ls -la pkl/ 2>/dev/null || echo "N/A"

      - name: üöÄ Executar
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN }}
        run: |
          # Iniciar Xvfb com configura√ß√£o completa
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset &
          XVFB_PID=$!
          sleep 3
          
          # Verificar se Xvfb est√° rodando
          if ! kill -0 $XVFB_PID 2>/dev/null; then
            echo "‚ùå Xvfb falhou ao iniciar!"
            exit 1
          fi
          echo "‚úÖ Xvfb rodando (PID: $XVFB_PID)"
          
          # Iniciar dbus
          eval $(dbus-launch --sh-syntax)
          
          # Executar bot
          python3 start.py

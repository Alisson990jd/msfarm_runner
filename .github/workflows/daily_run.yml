name: Microsoft Rewards Bot

on:
  workflow_dispatch:
    inputs:
      password:
        description: 'Senha de execu√ß√£o'
        required: true
        type: string

env:
  WORK_DIR: /home/runner/work/msfarm

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: üîê Validar senha
        run: |
          if [ "${{ github.event.inputs.password }}" != "${{ secrets.PASS }}" ]; then
            echo "‚ùå Senha incorreta!"
            exit 1
          fi
          echo "‚úÖ Senha v√°lida!"

      - name: üì• Baixar arquivos msfarm
        env:
          GH_TOKEN: ${{ secrets.GH_API_TOKEN }}
        run: |
          mkdir -p ${{ env.WORK_DIR }}/pkl
          cd ${{ env.WORK_DIR }}
          
          echo "üì• Baixando arquivos..."
          
          # Baixar arquivos principais
          FILES="start_env.py yt.py extension.zip emails.txt emails_usage.json"
          for file in $FILES; do
            echo "  ‚Üí $file"
            curl -sL -H "Authorization: token $GH_TOKEN" \
              "https://raw.githubusercontent.com/Alisson990jd/apiss/main/msfarm/$file" \
              -o "$file" 2>/dev/null || echo "    (n√£o encontrado)"
          done
          
          # Baixar PKLs
          echo "üì• Baixando PKLs..."
          PKL_LIST=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/Alisson990jd/apiss/contents/msfarm/pkl?ref=main" 2>/dev/null)
          
          echo "$PKL_LIST" | jq -r '.[]? | select(.type=="file") | .name' 2>/dev/null | while read name; do
            if [ -n "$name" ]; then
              echo "  ‚Üí pkl/$name"
              curl -sL -H "Authorization: token $GH_TOKEN" \
                "https://raw.githubusercontent.com/Alisson990jd/apiss/main/msfarm/pkl/$name" \
                -o "pkl/$name"
            fi
          done
          
          echo ""
          echo "üìÅ Arquivos baixados:"
          ls -la
          echo ""
          echo "üìÅ PKLs:"
          ls -la pkl/ 2>/dev/null || echo "(vazio)"

      - name: üêç Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ Instalar depend√™ncias
        run: |
          pip install --upgrade pip
          pip install discord.py aiohttp
          pip install playwright playwright-stealth
          pip install google-api-python-client google-auth google-auth-oauthlib google-auth-httplib2
          playwright install chromium
          playwright install-deps chromium

      - name: üñ•Ô∏è Instalar Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb x11-utils

      - name: üöÄ Executar Bot
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN }}
          DISPLAY: ":99"
        run: |
          cd ${{ env.WORK_DIR }}
          
          # Verificar arquivo
          if [ ! -f "start_env.py" ]; then
            echo "‚ùå start_env.py n√£o encontrado!"
            exit 1
          fi
          
          # Iniciar Xvfb
          echo "üñ•Ô∏è Iniciando Xvfb..."
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 3
          
          echo "üöÄ Iniciando bot..."
          python3 start_env.py

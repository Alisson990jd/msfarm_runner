name: Microsoft Rewards Bot

on:
  workflow_dispatch:
    inputs:
      password:
        description: 'Senha de execuÃ§Ã£o'
        required: true
        type: string
      action:
        description: 'AÃ§Ã£o a executar'
        required: true
        default: 'run'
        type: choice
        options:
          - run
          - test

env:
  WORK_DIR: /home/runner/work/msfarm

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.check.outputs.valid }}
    steps:
      - name: Validar senha
        id: check
        run: |
          if [ "${{ github.event.inputs.password }}" = "${{ secrets.PASS }}" ]; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "âœ… Senha vÃ¡lida!"
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "âŒ Senha incorreta!"
            exit 1
          fi

  setup-and-run:
    needs: validate
    if: needs.validate.outputs.valid == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: ðŸ“¦ Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: ðŸ Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¥ Baixar arquivos do repositÃ³rio msfarm
        env:
          GH_TOKEN: ${{ secrets.GH_API_TOKEN }}
        run: |
          mkdir -p ${{ env.WORK_DIR }}/pkl
          cd ${{ env.WORK_DIR }}
          
          echo "ðŸ“¥ Baixando arquivos da pasta msfarm..."
          
          # Baixar lista de arquivos
          curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/Alisson990jd/apiss/contents/msfarm?ref=main" | \
            jq -r '.[] | select(.type=="file") | "\(.name) \(.download_url)"' | \
            while read name url; do
              echo "  ðŸ“„ $name"
              curl -sL -H "Authorization: token $GH_TOKEN" "$url" -o "$name"
            done
          
          # Baixar pasta pkl
          PKL_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/Alisson990jd/apiss/contents/msfarm/pkl?ref=main")
          
          if [ "$PKL_STATUS" = "200" ]; then
            echo "ðŸ“¥ Baixando pasta pkl..."
            curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/Alisson990jd/apiss/contents/msfarm/pkl?ref=main" | \
              jq -r '.[] | select(.type=="file") | "\(.name) \(.download_url)"' | \
              while read name url; do
                echo "  ðŸ“„ pkl/$name"
                curl -sL -H "Authorization: token $GH_TOKEN" "$url" -o "pkl/$name"
              done
          fi
          
          echo "âœ… Download concluÃ­do!"
          ls -la

      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          pip install --upgrade pip
          pip install discord.py aiohttp playwright playwright-stealth
          pip install google-api-python-client google-auth google-auth-oauthlib google-auth-httplib2
          playwright install chromium
          playwright install-deps chromium

      - name: ðŸ–¥ï¸ Instalar Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb x11-utils

      - name: ðŸ”§ Modificar start.py para usar secrets
        run: |
          cd ${{ env.WORK_DIR }}
          
          # Usar sed para substituir as linhas hardcoded
          sed -i 's/DISCORD_TOKEN = ".*"/DISCORD_TOKEN = os.environ.get("DISCORD_TOKEN")/' start.py
          sed -i 's/CHANNEL_ID = [0-9]*/CHANNEL_ID = int(os.environ.get("DISCORD_CHANNEL_ID", "0"))/' start.py
          sed -i 's/GITHUB_TOKEN = ".*"/GITHUB_TOKEN = os.environ.get("GH_API_TOKEN")/' start.py
          
          # Adicionar validaÃ§Ã£o apÃ³s os imports
          sed -i '/^GITHUB_PATH = /a\
          \
          # Validar variÃ¡veis obrigatÃ³rias\
          if not DISCORD_TOKEN:\
              print("âŒ ERRO: DISCORD_TOKEN nÃ£o definido!")\
              sys.exit(1)\
          if not CHANNEL_ID:\
              print("âŒ ERRO: DISCORD_CHANNEL_ID nÃ£o definido!")\
              sys.exit(1)\
          if not GITHUB_TOKEN:\
              print("âŒ ERRO: GH_API_TOKEN nÃ£o definido!")\
              sys.exit(1)' start.py
          
          echo "âœ… start.py modificado!"
          
          # Verificar modificaÃ§Ãµes
          head -50 start.py

      - name: ðŸ“‹ Verificar arquivos
        run: |
          cd ${{ env.WORK_DIR }}
          echo "ðŸ“ Arquivos:"
          ls -la
          echo ""
          echo "ðŸ“ PKL:"
          ls -la pkl/ 2>/dev/null || echo "Pasta pkl vazia"

      - name: ðŸš€ Executar Bot
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN }}
          DISPLAY: ":99"
        run: |
          cd ${{ env.WORK_DIR }}
          
          # Iniciar Xvfb
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 3
          
          echo "ðŸš€ Iniciando bot..."
          python3 start.py
